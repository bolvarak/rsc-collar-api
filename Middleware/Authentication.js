///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'use strict'; /// Strict Syntax //////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
const $config = require('../Common/Configuration'); /// Configuration Module /////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
module.exports = ($httpRequest, $httpResponse, $nextCall) => { /// Authentication Module Definition //////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	// Make sure we have a device ID
	$httpRequest.expect('x-rsc-device-id');
	// Make sure we have an animal ID
	$httpRequest.expect('x-rsc-animal-id');
	// Iterate over the open URLs
	for (let $index = 0; $index < $config.auth.openUrls.length; ++$index) {
		// Check the URL
		if ($httpRequest.url.match($config.auth.openUrls[$index])) {
			// We're done, this endpoint is open
			return $nextCall();
		}
	}
	// Check the device ID
	if ($httpRequest.value('x-rsc-device-id') !== $config.auth.static.collar.macAddress) {
		// We're done, send the error
		return $httpRequest.raise('Invalid Device ID', 401);
	}
	// Check the animal ID
	if ($httpRequest.value('x-rsc-animal-id') !== $config.auth.static.collar.animalId) {
		// We're done, send the error
		return $httpRequest.raise('Invalid Animal ID', 401);
	}
	// We're done, authentication succeeded
	return $nextCall();

	/**
	 * TODO - Update this to pull information from a database as opposed to static test data
	 * TODO - Implement real data modeling for Device ID and Animal ID (i.e. store an $animal and $device object in $httpRequest for use inside the endpoints)
	 */

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}; /// End Authentication Module Definition //////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

